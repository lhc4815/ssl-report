<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSL ê³ êµì„ íƒì ì„±ê²€ì‚¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- í—¤ë” ì˜ì—­ -->
        <header class="main-header">
            <div class="header-content">
                <h1 class="header-title">SSL ê³ êµì„ íƒì ì„±ê²€ì‚¬ ì‹œìŠ¤í…œ</h1>
                <p class="header-subtitle">SSL Academic Aptitude Test System</p>
            </div>
        </header>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="main-content">
            <!-- ê²€ìƒ‰ ì„¹ì…˜ -->
            <div class="search-section">
                <h2 class="section-title">í•™ìƒ ë¦¬í¬íŠ¸ ì¡°íšŒ</h2>
                
                <div class="search-form-container">
                    <div class="form-group">
                        <label for="surveyType" class="form-label">ê²€ì‚¬ ì¢…ë¥˜ (Survey Type)</label>
                        <select id="surveyType" class="form-select">
                            <option value="ê³ êµì„ íƒì ì„±ê²€ì‚¬" selected>ê³ êµì„ íƒì ì„±ê²€ì‚¬</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="userName" class="form-label">ì´ë¦„ (Name)</label>
                        <input 
                            type="text" 
                            id="userName" 
                            class="form-input"
                            placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                            maxlength="20"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="userCode" class="form-label">ì½”ë“œ (Code)</label>
                        <input 
                            type="text" 
                            id="userCode" 
                            class="form-input"
                            placeholder="ë¶€ì—¬ë°›ì€ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                            maxlength="20"
                        >
                    </div>
                    
                    <button id="searchButton" class="search-button">
                        ë¡œê·¸ì¸
                    </button>
                    
                    <p class="form-note">
                        ë¶€ì—¬ë°›ì€ ì´ë¦„ê³¼ ì½”ë“œë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.
                    </p>
                </div>

                <div id="errorMessage" class="error-message" style="display: none;"></div>
                <div id="loadingMessage" class="loading-message" style="display: none;">
                    ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>

            <!-- í•™ìƒ ëª©ë¡ ì„¹ì…˜ -->
            <div class="student-list-section">
                <div class="section-header">
                    <h2 class="section-title">ë“±ë¡ëœ í•™ìƒ ëª©ë¡</h2>
                </div>
                
                <div class="table-container">
                    <table class="student-table" id="studentTable">
                        <thead>
                            <tr>
                                <th>ë²ˆí˜¸</th>
                                <th>ì½”ë“œ</th>
                                <th>ì´ë¦„</th>
                                <th>í•™êµ</th>
                                <th>í•™ë…„</th>
                                <th>ë¦¬í¬íŠ¸</th>
                            </tr>
                        </thead>
                        <tbody id="studentList">
                            <tr>
                                <td colspan="6" class="loading-placeholder">í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- í‘¸í„° -->
        <footer class="main-footer">
            <p>&copy; 2025 SSL ê³ êµì„ íƒì ì„±ê²€ì‚¬. All rights reserved.</p>
            <p class="footer-version">Version 2.0 | MySQL Database Connected</p>
        </footer>
    </div>

    <script src="js/ssl-dataProcessor.js"></script>
    <script>
        // DOM ë¡œë“œ ì™„ë£Œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ SSL Report System ì‹œì‘');
            
            // ìš”ì†Œë“¤ ê°€ì ¸ì˜¤ê¸°
            const userCodeInput = document.getElementById('userCode');
            const userNameInput = document.getElementById('userName');
            const searchButton = document.getElementById('searchButton');
            const errorMessage = document.getElementById('errorMessage');
            const loadingMessage = document.getElementById('loadingMessage');
            const studentList = document.getElementById('studentList');

            // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            searchButton.addEventListener('click', handleSearch);
            
            // Enter í‚¤ ì´ë²¤íŠ¸
            userCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleSearch();
            });
            userNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleSearch();
            });

            // ê²€ìƒ‰ ì²˜ë¦¬ í•¨ìˆ˜
            async function handleSearch() {
                const userCode = userCodeInput.value.trim();
                const userName = userNameInput.value.trim();

                // ì…ë ¥ ê²€ì¦
                if (!userCode) {
                    showError('ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (!userName) {
                    showError('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    showLoading(true);
                    hideError();

                    // í•™ìƒ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                    const response = await fetch(`/api/student/${userCode}`);
                    
                    if (response.ok) {
                        const studentData = await response.json();
                        
                        // ì´ë¦„ ê²€ì¦
                        if (studentData.user_name !== userName) {
                            showError(`ì…ë ¥í•œ ì´ë¦„(${userName})ê³¼ ë“±ë¡ëœ ì´ë¦„(${studentData.user_name})ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                            return;
                        }
                        
                        // ë¦¬í¬íŠ¸ í˜ì´ì§€ë¡œ ì´ë™
                        const params = new URLSearchParams({
                            userCode: userCode,
                            userName: studentData.user_name
                        });
                        
                        window.location.href = `student_report.html?${params.toString()}`;
                        
                    } else if (response.status === 404) {
                        showError('í•´ë‹¹ ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    } else {
                        throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                    }
                    
                } catch (error) {
                    console.error('âŒ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                    showError('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } finally {
                    showLoading(false);
                }
            }

            // í•™ìƒ ëª©ë¡ ë¡œë“œ
            async function loadStudentList() {
                try {
                    const students = await getStudentList();
                    displayStudentList(students);
                } catch (error) {
                    console.error('âŒ í•™ìƒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                    studentList.innerHTML = '<div class="error-placeholder">í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            }

            // í•™ìƒ ëª©ë¡ í‘œì‹œ
            function displayStudentList(students) {
                if (students.length === 0) {
                    studentList.innerHTML = '<tr><td colspan="6" class="empty-placeholder">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                studentList.innerHTML = students.map((student, index) => `
                    <tr data-user-code="${student.user_code}">
                        <td>${index + 1}</td>
                        <td>${student.user_code}</td>
                        <td>${student.user_name}</td>
                        <td>${student.school || 'ì •ë³´ì—†ìŒ'}</td>
                        <td>${student.grade ? student.grade + 'í•™ë…„' : 'ì •ë³´ì—†ìŒ'}</td>
                        <td>
                            <button class="table-report-btn" onclick="viewReport('${student.user_code}', '${student.user_name}')">
                                ğŸ“‹ ë¦¬í¬íŠ¸ ë³´ê¸°
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            // ë¦¬í¬íŠ¸ ë³´ê¸° (ì „ì—­ í•¨ìˆ˜)
            window.viewReport = function(userCode, userName) {
                const params = new URLSearchParams({
                    userCode: userCode,
                    userName: userName
                });
                window.location.href = `student_report.html?${params.toString()}`;
            };

            // UI í—¬í¼ í•¨ìˆ˜ë“¤
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                setTimeout(() => {
                    hideError();
                }, 5000);
            }

            function hideError() {
                errorMessage.style.display = 'none';
            }

            function showLoading(show) {
                loadingMessage.style.display = show ? 'block' : 'none';
                searchButton.disabled = show;
                if (show) {
                    searchButton.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
                } else {
                    searchButton.textContent = 'ë¡œê·¸ì¸';
                }
            }

            // ì´ˆê¸° í•™ìƒ ëª©ë¡ ë¡œë“œ
            loadStudentList();
        });
    </script>
</body>
</html>
